<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POS — Réplica Cuenti (Mock)</title>
  <style>
    :root{--bg:#f3f6fb;--card:#ffffff;--accent:#0b63c6;--muted:#6b7280;--success:#16a34a;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:#0f1724}
    .wrap{display:grid;grid-template-columns:300px 1fr 420px;gap:16px;padding:16px;height:100vh}
    .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 1px 4px rgba(16,24,40,0.05);display:flex;flex-direction:column}
    .brand{font-weight:700;color:var(--accent);font-size:18px}
    .small{font-size:13px;color:var(--muted)}
    /* Left: mesas */
    #mesasGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .mesa{padding:10px;border-radius:8px;border:1px solid #e6eef8;cursor:pointer;background:#fff}
    .mesa.occ{border-color:#f59e0b;background:#fff7e6}
    /* Center: productos */
    #controls{display:flex;gap:8px;align-items:center}
    #cats{display:flex;gap:6px;overflow:auto;margin-top:8px}
    .cat{padding:6px 10px;border-radius:999px;background:#eef2ff;border:1px solid #e6edff;cursor:pointer;font-size:13px}
    .cat.active{background:var(--accent);color:#fff}
    #products{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:12px;overflow:auto}
    .prod{background:#fff;padding:10px;border-radius:8px;border:1px solid #e9f0ff;cursor:pointer;display:flex;flex-direction:column;gap:6px;align-items:center}
    .prod img{width:100%;height:90px;object-fit:cover;border-radius:6px}
    .prodName{font-weight:600}
    .prodPrice{color:var(--muted);font-size:13px}
    /* Right: carrito */
    #cartList{overflow:auto;max-height:60vh;margin-top:8px}
    .line{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #f3f6fb}
    .qty{display:inline-block;padding:4px 8px;border-radius:6px;background:#f3f6fb}
    .row-actions{display:flex;gap:6px}

    .footer-actions{display:flex;gap:8px;margin-top:10px}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.success{background:var(--success);color:#fff}
    .btn.ghost{background:transparent;border:1px solid #e6eef8}

    /* Modal */
    #modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center}
    #modal .box{background:#fff;padding:14px;border-radius:8px;width:520px;max-height:80vh;overflow:auto}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Left -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="brand">Cuenti - Mock POS</div>
          <div class="small">Réplica rápida — Mock facturación</div>
        </div>
        <div class="small">v1</div>
      </div>

      <div style="margin-top:12px"><strong>Mesas / Puntos</strong></div>
      <div id="mesasGrid"></div>

      <div style="margin-top:12px"><input id="newMesa" placeholder="Nombre mesa" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8"/></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="addMesaBtn" class="btn primary">Agregar mesa</button>
        <button id="resetBtn" class="btn ghost">Reset</button>
      </div>

      <div style="margin-top:12px" class="small">Buscar mesas</div>
      <input id="searchMesa" placeholder="Buscar..." style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8;margin-top:6px" />
    </div>

    <!-- Center -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700;font-size:16px">Productos</div>
          <div class="small">Inventario y menú</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <input id="searchProd" placeholder="Buscar producto..." style="padding:8px;border-radius:6px;border:1px solid #e6eef8" />
          <button id="demoBtn" class="btn ghost">Demo</button>
        </div>
      </div>

      <div id="cats"></div>
      <div id="products"></div>
    </div>

    <!-- Right -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Carrito</strong><div class="small" id="tableLabel">Mesa: -</div></div>
        <div class="small" id="orderCount">0 items</div>
      </div>

      <div id="cartList"></div>

      <div style="margin-top:8px">
        <div style="display:flex;justify-content:space-between"><div class="small">Subtotal</div><div id="subtotal">$0</div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="small">Propina %</div><input id="tipPct" type="number" min="0" max="100" value="0" style="width:80px;padding:6px;border-radius:6px;border:1px solid #e6eef8" onchange="updateTotals()"/></div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-weight:700"><div>Total</div><div id="grandTotal">$0</div></div>
      </div>

      <div class="footer-actions">
        <button id="factBtn" class="btn primary">Emitir factura (mock)</button>
        <button id="checkoutBtn" class="btn success">Cobrar</button>
        <button id="reportsBtn" class="btn ghost">Reportes</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal"><div class="box" id="modalBox"></div></div>

  <script>
    // Simple POS inspired by Cuenti — mock electronic invoice generator
    const STORAGE_KEY = 'pos_cuenti_mock_v1';
    const state = { mesas: [], categorias: [], productos: [], pedidos: {}, ventas: [] };

    function save(){localStorage.setItem(STORAGE_KEY, JSON.stringify(state))}
    function load(){ const s = localStorage.getItem(STORAGE_KEY); if(s) Object.assign(state, JSON.parse(s)); else initDemo(); }

    function initDemo(){
      state.categorias = ['Comidas','Bebidas','Postres'];
      state.productos = [
        {id:gid(),name:'Hamburguesa Doble',price:16000,cat:'Comidas',stock:20},
        {id:gid(),name:'Pizza Familiar',price:28000,cat:'Comidas',stock:8},
        {id:gid(),name:'Gaseosa 500ml',price:4500,cat:'Bebidas',stock:30},
        {id:gid(),name:'Cerveza',price:8000,cat:'Bebidas',stock:40},
        {id:gid(),name:'Helado',price:6000,cat:'Postres',stock:15}
      ];
      state.mesas = ['Mesa 1','Mesa 2','Mesa 3','Caja'];
      state.pedidos = {};
      state.ventas = [];
      save();
    }

    function gid(){return 'x'+Math.random().toString(36).slice(2,9)}

    // Rendering
    const mesasGrid = () => document.getElementById('mesasGrid');
    const productsEl = () => document.getElementById('products');
    const catsEl = () => document.getElementById('cats');
    const cartList = () => document.getElementById('cartList');
    let activeMesa = null;
    let activeCat = null;

    function renderMesas(){
      const grid = mesasGrid();
      grid.innerHTML='';
      const q=document.getElementById('searchMesa').value.toLowerCase();
      state.mesas.filter(m=>m.toLowerCase().includes(q)).forEach(m=>{
        const occ = (state.pedidos[m] && state.pedidos[m].length>0);
        const div = document.createElement('div');
        div.className = 'mesa' + (occ? ' occ':'');
        div.innerHTML = `<div style="font-weight:600">${m}</div><div class="small">${occ? state.pedidos[m].length + ' ítems - $'+sum(m): 'Libre'}</div>`;
        div.onclick = ()=>{ activeMesa = m; document.getElementById('tableLabel').textContent = 'Mesa: '+m; renderCart(); };
        grid.appendChild(div);
      });
    }

    function renderCats(){
      const el = catsEl();
      el.innerHTML='';
      state.categorias.forEach(c=>{
        const b=document.createElement('div');
        b.className='cat'+(c===activeCat?' active':'');
        b.textContent = c;
        b.onclick = ()=>{ activeCat=c; renderProducts(); renderCats(); };
        el.appendChild(b);
      });
    }

    function renderProducts(){
      const el = productsEl();
      el.innerHTML='';
      const term = document.getElementById('searchProd').value.toLowerCase();
      state.productos.filter(p=> (activeCat? p.cat===activeCat:true) && p.name.toLowerCase().includes(term)).forEach(p=>{
        const d=document.createElement('div');
        d.className='prod';
        d.innerHTML = `<div style="font-weight:600">${p.name}</div><div class="small">${p.cat} • Stock: ${p.stock||0}</div><div style="margin-top:6px;font-weight:700">$${p.price}</div>`;
        d.onclick = ()=> addToCart(p.id);
        el.appendChild(d);
      });
    }

    function addMesa(){ const v = document.getElementById('newMesa').value.trim(); if(!v) return alert('Ingrese nombre de la mesa'); state.mesas.push(v); document.getElementById('newMesa').value=''; save(); renderMesas(); }

    function seedProducts(){ initDemo(); load(); renderAll(); }
    function resetDemo(){ if(confirm('Resetear demo?')){ localStorage.removeItem(STORAGE_KEY); initDemo(); load(); renderAll(); } }

    function addToCart(pid){ if(!activeMesa) return alert('Selecciona una mesa'); const prod = state.productos.find(x=>x.id===pid); if(!prod) return; if(prod.stock<=0) return alert('Sin stock'); if(!state.pedidos[activeMesa]) state.pedidos[activeMesa]=[]; const ex = state.pedidos[activeMesa].find(i=>i.id===pid); if(ex){ ex.qty++; } else { state.pedidos[activeMesa].push({ id:prod.id, name:prod.name, price:prod.price, qty:1 }); } prod.stock--; save(); renderCart(); renderMesas(); }

    function renderCart(){ const el = cartList(); el.innerHTML=''; if(!activeMesa){ el.innerHTML = '<div class="small">Seleccione mesa</div>'; document.getElementById('orderCount').textContent='0 items'; updateTotals(); return; } const items = state.pedidos[activeMesa]||[]; if(!items.length){ el.innerHTML = '<div class="small">Carrito vacío</div>'; document.getElementById('orderCount').textContent='0 items'; updateTotals(); return; } items.forEach((it,idx)=>{ const row = document.createElement('div'); row.className='line'; row.innerHTML = `<div><div style="font-weight:600">${it.name}</div><div class="small">x${it.qty}</div></div><div style="display:flex;gap:8px;align-items:center"><div>$${it.price*it.qty}</div><div class="row-actions"><button class="btn" onclick="inc(${idx})">+</button><button class="btn" onclick="dec(${idx})">-</button><button class="btn" onclick="removeItem(${idx})">x</button></div></div>`; el.appendChild(row); }); document.getElementById('orderCount').textContent = items.reduce((s,i)=>s+i.qty,0) + ' items'; updateTotals(); }

    function inc(idx){ const items = state.pedidos[activeMesa]; const item = items[idx]; const prod = state.productos.find(p=>p.id===item.id); if(prod.stock<=0) return alert('Sin stock'); item.qty++; prod.stock--; save(); renderCart(); renderMesas(); }
    function dec(idx){ const items = state.pedidos[activeMesa]; const item = items[idx]; const prod = state.productos.find(p=>p.id===item.id); if(item.qty>1){ item.qty--; prod.stock++; } else { // remove
      prod.stock += item.qty; items.splice(idx,1);
    } save(); renderCart(); renderMesas(); }
    function removeItem(idx){ const items = state.pedidos[activeMesa]; const item = items[idx]; const prod = state.productos.find(p=>p.id===item.id); prod.stock += item.qty; items.splice(idx,1); save(); renderCart(); renderMesas(); }

    function sum(m){ const it = state.pedidos[m]||[]; return it.reduce((s,i)=>s + i.price*i.qty, 0); }
    function updateTotals(){ const items = state.pedidos[activeMesa]||[]; const sub = items.reduce((s,i)=>s + i.price*i.qty, 0); document.getElementById('subtotal').textContent = '$' + sub; const tip = Number(document.getElementById('tipPct').value||0); const total = Math.round(sub * (1 + tip/100)); document.getElementById('grandTotal').textContent = '$' + total; }

    // Mock factura electrónica: generate structured JSON and allow download/print
    function mockFactura(){
      if(!activeMesa) return alert('Seleccione mesa');
      const items = state.pedidos[activeMesa]||[];
      if(!items.length) return alert('Carrito vacío');
      const tip = Number(document.getElementById('tipPct').value||0);
      const sub = items.reduce((s,i)=>s + i.price*i.qty, 0);
      const total = Math.round(sub * (1 + tip/100));

      const factura = {
        id: 'FAC-'+gid().toUpperCase().slice(2,10),
        fecha: new Date().toISOString(),
        mesa: activeMesa,
        items: JSON.parse(JSON.stringify(items)),
        subtotal: sub,
        propinaPct: tip,
        total
      };

      // Build modal content using DOM methods (safer than concatenated strings)
      const box = document.getElementById('modalBox');
      box.innerHTML = '';

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.justifyContent = 'space-between';
      header.style.alignItems = 'center';

      const hTitle = document.createElement('div');
      hTitle.innerHTML = '<strong>Factura simulada</strong>';
      const hClose = document.createElement('div');
      const btnClose = document.createElement('button'); btnClose.className = 'btn ghost'; btnClose.textContent = 'Cerrar'; btnClose.onclick = closeModal;
      hClose.appendChild(btnClose);
      header.appendChild(hTitle); header.appendChild(hClose);

      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(factura, null, 2);

      const actions = document.createElement('div'); actions.style.display = 'flex'; actions.style.gap = '8px'; actions.style.marginTop = '8px';
      const btnDownload = document.createElement('button'); btnDownload.className = 'btn primary'; btnDownload.textContent = 'Descargar JSON'; btnDownload.onclick = ()=> downloadFacturaObj(factura);
      const btnPrint = document.createElement('button'); btnPrint.className = 'btn'; btnPrint.textContent = 'Imprimir'; btnPrint.onclick = ()=> printFacturaObj(factura);
      actions.appendChild(btnDownload); actions.appendChild(btnPrint);

      box.appendChild(header); box.appendChild(pre); box.appendChild(actions);
      document.getElementById('modal').style.display = 'flex';
    }

    function downloadFacturaObj(obj){ const data = JSON.stringify(obj, null, 2); const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (obj.id || 'factura') + '.json'; a.click(); URL.revokeObjectURL(url); }

    function printFacturaObj(obj){ const w = window.open('','_blank'); if(!w) return alert('El navegador bloqueó la ventana emergente. Permite ventanas emergentes para imprimir.'); w.document.open(); w.document.write('<!doctype html><html><head><meta charset="utf-8"><title>Factura '+(obj.id||'')+'</title></head><body><pre id="ct"></pre></body></html>'); w.document.close(); try{ w.document.getElementById('ct').textContent = JSON.stringify(obj, null, 2); } catch(e){ /* fallback */ w.document.body.innerText = JSON.stringify(obj, null, 2); } w.focus(); w.print(); }

    function closeModal(){ document.getElementById('modal').style.display='none'; }

    // Checkout: register sale, clear order, keep sale in history
    function checkout(){ if(!activeMesa) return alert('Seleccione mesa'); const items = state.pedidos[activeMesa]||[]; if(!items.length) return alert('Carrito vacío'); const tip = Number(document.getElementById('tipPct').value||0); const sub = items.reduce((s,i)=>s + i.price*i.qty, 0); const total = Math.round(sub * (1 + tip/100)); const venta = { id: gid(), mesa: activeMesa, items: JSON.parse(JSON.stringify(items)), subtotal: sub, tipPct: tip, total, fecha: new Date().toISOString() }; state.ventas.push(venta); // clear
      state.pedidos[activeMesa] = []; save(); renderCart(); renderMesas(); alert('Venta registrada $'+total); }

    // Reports
    function showReports(){ const box = document.getElementById('modalBox'); let html = '<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Reportes</strong></div><div><button class="btn ghost" onclick="closeModal()">Cerrar</button></div></div><table style="width:100%;border-collapse:collapse;margin-top:8px"><tr><th>Mesa</th><th>Total</th><th>Fecha</th></tr>';
      state.ventas.forEach(v=>{ html += `<tr><td style="padding:8px">${v.mesa}</td><td style="padding:8px">$${v.total}</td><td style="padding:8px">${new Date(v.fecha).toLocaleString()}</td></tr>` }); html += '</table><div style="display:flex;gap:8px;margin-top:8px"><button class="btn primary" onclick="exportSales()">Exportar CSV</button></div>';
      box.innerHTML = html; document.getElementById('modal').style.display = 'flex'; }

    function exportSales(){ if(!state.ventas.length) return alert('No hay ventas'); let csv = 'id,mesa,total,fecha
'; state.ventas.forEach(v=> csv += `${v.id},"${v.mesa}",${v.total},${v.fecha}
`); const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'ventas.csv'; a.click(); URL.revokeObjectURL(url); }

    // Utilities
    function sumAll(){ return state.mesas.reduce((s,m)=> s + (sum(m)||0), 0); }

    // Init + helpers
    function renderAll(){ renderMesas(); renderProducts(); renderCart(); renderCats(); }

    load(); renderAll();

    // Attach event listeners (avoid inline onclick pitfalls)
    document.getElementById('addMesaBtn').addEventListener('click', addMesa);
    document.getElementById('resetBtn').addEventListener('click', resetDemo);
    document.getElementById('searchMesa').addEventListener('input', renderMesas);
    document.getElementById('demoBtn').addEventListener('click', seedProducts);
    document.getElementById('searchProd').addEventListener('input', renderProducts);
    document.getElementById('factBtn').addEventListener('click', mockFactura);
    document.getElementById('checkoutBtn').addEventListener('click', checkout);
    document.getElementById('reportsBtn').addEventListener('click', showReports);

  </script>
</body>
</html>

